
/* TableNameVariable */ 

declare @tableName nvarchar(max) = '[' + @schema + '].[' + @tablePrefix + 'theSaga]';

/* CreateTable */ 

if not exists
(
    select *
    from sys.objects
    where
        object_id = object_id(@tableName) and
        type in ('U')
)
begin
declare @createTable nvarchar(max);
set @createTable = '
    create table ' + @tableName + '(
        [Id] [uniqueidentifier] not null primary key,
        [Originator] [nvarchar](255),
        [OriginalMessageId] [nvarchar](255),
        [Data] [nvarchar](max) not null,
        [PersistenceVersion] [varchar](23) not null,
        [SagaTypeVersion] [varchar](23) not null
    )
';
exec(@createTable);
end

/* PurgeObsoleteIndex */ 

declare @dropIndexQuery nvarchar(max);
select @dropIndexQuery =
(
    select 'drop index ' + name + ' on ' + @tableName + ';'
    from sysindexes
    where
        Id = (select object_id from sys.objects where name = @tableName) and
        Name is not null and
        Name like 'Index_Correlation_%'
);
exec sp_executesql @dropIndexQuery

/* PurgeObsoleteProperties */ 

declare @dropPropertiesQuery nvarchar(max);
select @dropPropertiesQuery =
(
    select 'alter table ' + @tableName + ' drop column ' + col.column_name ';'
    from information_schema.columns col
    where
        col.table_name = @tableName and
        col.column_name like 'Correlation_%'
);
exec sp_executesql @dropPropertiesQuery
